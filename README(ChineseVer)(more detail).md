# 基于AVX2与FMA3的图像卷积
这组程序基于AVX2与FMA3的汇编实现。三个文件的核心代码是一致的。  
AVX2 与 FMA3都是SIMD扩展指令集。二者允许处理器使用256位的YMM寄存器同时处理8个单精度浮点数或者4个双精度浮点数。
## 简介
本仓库中有三个基于不同并行框架的程序：MPI、pthread、OpenMP。  
pthread和OpenMP是共享内存并行模型，在单一机器上运行可能会更快。  
同样的，MPI是分布式内存模型，它可以运行在一组通过网络连接的计算机上。
## 环境要求
### 硬件要求
显然，您需要一块（对于MPI，或者多块）支持AVX2 和 FMA3的x86-64(AMD64)处理器。
### 软件要求
#### MPI
您可以尝试在Windows上使用MSMPI，在Linux上使用MPICH。
#### pthread
您需要在支持POSIX线程模型的操作系统上运行相关程序。您可以尝试Linux 或 macOS。
#### OpenMP
您仅需要一个支持OpenMP的编译器。

## 编译命令(基于Linux / macOS)
### MPI
```
mpicc -g -Wall -o mpiConv mpi.c 
```
### pthread
```
gcc -g -Wall -o pthreadConv pthread.c -lpthread
```
### OpenMP
```
gcc -Wall -o OpenMPConv openmp.c -fopenmp
```
## 运行程序
### Step 1.  
将您需要卷积的图像重命名为1.bmp，将其置于与可执行文件同目录下，该图片不能被压缩，即：若该图片大小为w * h * 3，其占用存储空间应当为(54 + w * h * 3)字节。

### Step 2.
通过命令行运行程序。您需要在执行时向程序传递一个参数。该参数决定了程序使用的线程(pthread OpenMP)或进程数(MPI)。  
以下是使用pthread通过4个线程进行卷积的命令。
```
./pthreadConv 4
```
### Step 3.
程序会自动在同目录下生成卷积结果。它会被命名为mpi.bmp / pthread.bmp / openmp.bmp.
## 注意
卷积核是一个5 * 5的高斯核。您可以直接在程序中将其修改成自己希望的卷积核。  
卷积模式为SAME，这代表着若1.bmp是一张w * h * 3图像，卷积时该图将被两个像素宽度的黑边包围，最终卷积成为w * h * 3的图像。  
mpi.c 在macOS Big Sur中运行时可能出现错误。(Segment fault)
## 性能
以下数据均在下列测试环境中得到:  
CPU: Intel Core i7 9700  
RAM: 16 GB DDR4-2666  
OS: Ubuntu 20.01 LTS
Compiler: MPICC / GCC 10.2
| Arch | 2 Thread / s | 4 Thread / s | 8 Thread / s |
| ---- | -------- | -------- | -------- |
| MPI(Win10 MSMPI) | 0.107567 | 0.088506 | 0.080368 |
| pthread | 0.131346 | 0.081878 | 0.074302 |
| OpenMP | 0.119463 | 0.086379 | 0.064605 |

\* 对 4096 * 2304 * 3 的 bmp 图像进行卷积   
\* 以上数据为整个程序执行的时间，包括从硬盘加载图片至讲卷积结果写回硬盘
## 致谢
我的课程教师: 张教授  
课程助教: 庄同学  
我自己: 韩  
以及我的电脑。
## Postscripst
您可以通过hml0814@163.com联系我。     
事实上，这个仓库的内容是2020-2021学年春季学期的《并行编程原理与实现》课程的四个大作业之三，全部由我自己实现，无借鉴。  
由于在优化性能方面花了很大的功夫，不发出来有点可惜。（Doge）  
如果您希望在学术层面（包括但不限于论文、展示、课程设计、大作业等）使用或借鉴该仓库的代码，请向您的导师声明您的借鉴行为和借鉴范围，且在您的成果中注明您的借鉴行为和借鉴范围。  
该仓库的代码开放商用，但是您需要以邮件形式告知我。如果您已经向我发送了说明邮件，您不需要等待我的授权，可以直接使用代码。  
欢迎各位使用Pull requestion为本仓库的代码进行优化。   